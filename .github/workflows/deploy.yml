name: Deploy to VPS with Podman

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DEPLOY_TIMEOUT: 600

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: üîç Verify SSH Connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          echo "üîå Testando conex√£o SSH..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST "echo '‚úÖ Conex√£o SSH estabelecida com sucesso!'"

      - name: üöÄ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST "export PROJECT_PATH='$VPS_PROJECT_PATH' && bash -s" << 'EOF'
            set -e
            
            echo "============================================"
            echo "üöÄ Iniciando Deploy - $(date '+%Y-%m-%d %H:%M:%S')"
            echo "============================================"
            
            # Verificar se o diret√≥rio existe
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "‚ö†Ô∏è Diret√≥rio $PROJECT_PATH n√£o encontrado!"
              echo "üìÇ Criando estrutura de diret√≥rios..."
              mkdir -p "$(dirname "$PROJECT_PATH")"
              cd "$(dirname "$PROJECT_PATH")"
              
              echo "üì• Clonando reposit√≥rio..."
              git clone https://github.com/bielsolosos/Redirect-Lab.git
              
              if [ ! -d "$PROJECT_PATH" ]; then
                echo "‚ùå Erro: Falha ao clonar o reposit√≥rio!"
                exit 1
              fi
              
              echo "‚úÖ Reposit√≥rio clonado com sucesso!"
            fi
            
            # Navegar para o diret√≥rio do projeto
            cd "$PROJECT_PATH"
            echo "üìÇ Diret√≥rio atual: $(pwd)"
            
            # Verificar branch atual
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "üåø Branch atual: $CURRENT_BRANCH"
            
            # Fazer backup da branch atual (caso precise reverter)
            BACKUP_COMMIT=$(git rev-parse HEAD)
            echo "üíæ Backup do commit: $BACKUP_COMMIT"
            
            echo ''
            echo 'üì¶ Atualizando c√≥digo do reposit√≥rio...'
            git fetch origin main
            git pull origin main
            
            NEW_COMMIT=$(git rev-parse HEAD)
            echo "‚úÖ C√≥digo atualizado para commit: $NEW_COMMIT"
            
            echo ''
            echo 'üõë Parando containers...'
            podman compose down || echo '‚ö†Ô∏è Nenhum container estava rodando'
            
            echo ''
            echo 'üî® Fazendo build das imagens...'
            podman compose build --no-cache
            
            echo ''
            echo '‚ú® Iniciando containers...'
            podman compose up -d
            
            # Aguardar containers iniciarem
            echo ''
            echo '‚è≥ Aguardando containers iniciarem...'
            sleep 5
            
            # Verificar se containers est√£o rodando
            echo ''
            echo 'üîç Verificando status dos containers...'
            if podman compose ps | grep -q Up; then
              echo '‚úÖ Containers iniciados com sucesso!'
            else
              echo '‚ùå Erro: Containers n√£o est√£o rodando!'
              echo 'üìã Logs dos containers:'
              podman compose logs --tail=50
              exit 1
            fi
            
            echo ''
            echo 'üßπ Limpando imagens antigas...'
            podman image prune -f
            
            echo ''
            echo '============================================'
            echo '‚úÖ Deploy conclu√≠do com sucesso!'
            echo '============================================'
            echo ''
            echo 'üìä Status final dos containers:'
            podman compose ps
            echo ''
            echo 'üíª Informa√ß√µes do sistema:'
            echo "   - Commit: $NEW_COMMIT"
            echo "   - Data: $(date +%Y-%m-%d\ %H:%M:%S)"
            echo "   - Usu√°rio: $(whoami)"
            echo "   - Hostname: $(hostname)"
          EOF


      - name: üîç Health Check
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          echo "üè• Executando health check..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST "export PROJECT_PATH='$VPS_PROJECT_PATH' && bash -s" << 'EOF'
            cd "$PROJECT_PATH"
            
            # Verificar se os containers est√£o saud√°veis
            RUNNING_CONTAINERS=$(podman compose ps --format json | jq -r '.[].State' | grep -c running || echo 0)
            echo "üìä Containers rodando: $RUNNING_CONTAINERS"
            
            if [ "$RUNNING_CONTAINERS" -eq 0 ]; then
              echo '‚ùå Health check falhou: Nenhum container rodando'
              exit 1
            fi
            
            echo '‚úÖ Health check passou: Aplica√ß√£o rodando corretamente'
          EOF


      - name: üìù Deployment Summary
        if: always()
        run: |
          echo "## üìã Resumo do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
